<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Generation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        #status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        #status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        #status.loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔬 בדיקת יצירת PDF עם טקסט עברי</h1>
        <p>טסט זה בודק שהפונקציה generateProposalPDF עובדת כראוי עם:</p>
        <ul>
            <li>✅ פונט Rubik שתומך בעברית</li>
            <li>✅ RTL (כתיבה מימין לשמאל) עם setR2L(true)</li>
            <li>✅ טעינת פונט דינמית עם fetch()</li>
            <li>✅ יצירת PDF מלא עם טבלה</li>
        </ul>

        <button id="testBtn" onclick="runTest()">🚀 הרץ בדיקה</button>

        <div id="status"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

    <script>
        async function loadFont(path) {
            const response = await fetch(path);
            const blob = await response.blob();

            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.readAsDataURL(blob);
            });
        }

        async function runTest() {
            const statusEl = document.getElementById('status');
            const btnEl = document.getElementById('testBtn');

            try {
                btnEl.disabled = true;
                statusEl.className = 'loading';
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<strong>⏳ טוען פונט...</strong>';

                const rubikFont = await loadFont('/fonts/Rubik-VariableFont_wght.ttf');
                statusEl.innerHTML = '<strong>⏳ יוצר PDF...</strong>';

                const doc = new window.jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                });

                doc.addFileToVFS('Rubik-VariableFont_wght.ttf', rubikFont);
                doc.addFont('Rubik-VariableFont_wght.ttf', 'Rubik', 'normal');
                doc.addFont('Rubik-VariableFont_wght.ttf', 'Rubik', 'bold');

                doc.setFont('Rubik');
                doc.setR2L(true);

                doc.setFontSize(28);
                doc.setFont('Rubik', 'bold');
                doc.setTextColor(37, 99, 235);
                doc.text('הצעת מחיר', 105, 40, { align: 'center' });

                doc.setFontSize(14);
                doc.setFont('Rubik', 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text('שם לקוח: חברת בדיקה בע"מ', 190, 60, { align: 'right' });
                doc.text('תאריך: 07/10/2025', 190, 70, { align: 'right' });

                doc.setFontSize(12);
                const hebrewText = 'זהו טסט לבדיקת תמיכה בעברית. הפונט Rubik תומך בכל התווים העבריים וה-RTL פועל כראוי.';
                const lines = doc.splitTextToSize(hebrewText, 160);
                doc.text(lines, 190, 90, { align: 'right' });

                doc.autoTable({
                    startY: 110,
                    head: [['#', 'שירות', 'מחיר']],
                    body: [
                        ['1', 'אוטומציה של תהליכים', '₪15,000'],
                        ['2', 'אינטגרציה עם Zoho', '₪8,000'],
                        ['3', 'פיתוח AI Agent', '₪12,000'],
                    ],
                    styles: {
                        font: 'Rubik',
                        fontSize: 11,
                        halign: 'right',
                    },
                    headStyles: {
                        fillColor: [37, 99, 235],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        halign: 'center',
                    },
                });

                doc.save('test-hebrew-pdf.pdf');

                statusEl.className = 'success';
                statusEl.innerHTML = `
                    <strong>✅ הצלחה!</strong><br>
                    הבדיקה הושלמה בהצלחה:<br>
                    • פונט Rubik נטען ✓<br>
                    • RTL מופעל ✓<br>
                    • טקסט עברי מוצג נכון ✓<br>
                    • טבלה עם עברית עובדת ✓<br>
                    • PDF הורד בהצלחה ✓
                `;

            } catch (error) {
                statusEl.className = 'error';
                statusEl.innerHTML = `
                    <strong>❌ שגיאה!</strong><br>
                    ${error.message}<br><br>
                    <pre>${error.stack}</pre>
                `;
            } finally {
                btnEl.disabled = false;
            }
        }
    </script>
</body>
</html>
